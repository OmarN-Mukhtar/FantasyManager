name: Daily Data Update

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  workflow_dispatch:  # Allow manual trigger

jobs:
  daily-update:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        lfs: true
    
    - name: Pull Git LFS files
      run: git lfs pull
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python -c "import nltk; nltk.download('punkt'); nltk.download('brown')"
        python -m textblob.download_corpora
    
    - name: Verify CSV file
      run: |
        if [ -f "cleaned_merged_seasons.csv" ]; then
          echo "âœ… Found cleaned_merged_seasons.csv"
          echo "File size: $(du -h cleaned_merged_seasons.csv | cut -f1)"
        else
          echo "âŒ cleaned_merged_seasons.csv not found!"
          exit 1
        fi
    
    - name: Step 1 - Fetch FPL data and news
      run: |
        echo "ğŸ“Š Fetching latest FPL data and news for top 150 players (last 7 days)..."
        python src/data_fetcher.py
    
    - name: Step 2 - Run sentiment analysis
      run: |
        echo "ğŸ“Š Analyzing sentiment on fresh news..."
        python src/sentiment_analyzer.py
    
    - name: Step 3 - Generate predictions with sentiment
      run: |
        echo "ğŸ”® Generating predictions (incorporating sentiment scores)..."
        python src/predictor.py
    
    - name: Check generated files
      run: |
        echo "ğŸ“ Generated files:"
        ls -lh data/*.json 2>/dev/null || echo "No JSON files found"
        
        if [ -f "data/predictions.json" ]; then
          echo "âœ… predictions.json exists"
        fi
        
        if [ -f "data/sentiment_analysis.json" ]; then
          echo "âœ… sentiment_analysis.json exists"
        fi
        
        if [ -f "data/news.json" ]; then
          echo "âœ… news.json exists"
        fi
    
    - name: Commit and push updates
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add all generated data files
        git add data/players.json data/news.json data/predictions.json data/sentiment_analysis.json data/players_with_sentiment.csv data/qualified_players.csv 2>/dev/null || true
        
        # Only commit if there are staged changes
        if git diff --staged --quiet; then
          echo "â„¹ï¸  No changes to commit"
        else
          git commit -m "ğŸ¤– Daily update: news, sentiment, and predictions with sentiment analysis"
          git push
          echo "âœ… Changes committed and pushed"
        fi
