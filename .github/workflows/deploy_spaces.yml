name: Deploy to Hugging Face Spaces

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'app.py'
      - 'spaces_requirements.txt'
      - 'data/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        lfs: true
        
    - name: Push to Hugging Face Spaces
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN || 'not-set' }}
      run: |
        # Install git-lfs if needed
        git lfs install
        
        # Configure git
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        # Clone the Hugging Face Space repository
        # Replace YOUR_USERNAME and YOUR_SPACE_NAME with your actual values
        # Or use GitHub secrets for flexibility
        SPACE_REPO="${{ secrets.HF_SPACE_REPO }}"
        
        if [ -z "$SPACE_REPO" ]; then
          echo "âš ï¸ HF_SPACE_REPO secret not set. Skipping deployment."
          echo "Set it to: https://huggingface.co/spaces/YOUR_USERNAME/YOUR_SPACE_NAME"
          exit 0
        fi
        
        # Clone HF Space
        git clone https://huggingface.co/spaces/$SPACE_REPO hf-space
        
        # Copy necessary files
        cp app.py hf-space/
        cp spaces_requirements.txt hf-space/requirements.txt
        cp -r src hf-space/
        cp -r data hf-space/ 2>/dev/null || echo "No data directory to copy"
        cp README.md hf-space/ 2>/dev/null || echo "No README to copy"
        
        # Navigate to HF space directory
        cd hf-space
        
        # Configure HF authentication
        git config credential.helper store
        echo "https://user:${HF_TOKEN}@huggingface.co" > ~/.git-credentials
        
        # Commit and push
        git add .
        git diff --quiet && git diff --staged --quiet || git commit -m "ðŸš€ Auto-deploy from GitHub Actions"
        git push
        
        echo "âœ… Successfully deployed to Hugging Face Spaces!"
